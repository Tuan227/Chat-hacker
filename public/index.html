<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Chia s·∫ª T√†i li·ªáu</title>
  <style>
    html, body {
      scroll-behavior: smooth;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f7f7f7;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
    }
    input, textarea, select {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .link-btn {
      background: red;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      margin: 5px 0;
      cursor: pointer;
      font-size: 15px;
    }
    .link-btn:active {
      background: #00ff00;
    }
    .doc-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 20px;
      position: relative;
    }
    .preview {
      max-width: 150px;
      max-height: 150px;
      margin: 10px 0;
      display: block;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .delete-btn {
      position: absolute; top: 10px; right: 10px;
      background: red; color: #fff;
      border: none; padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    footer {
      text-align: center;
      margin: 40px 0 20px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>üìò Chia s·∫ª T√†i li·ªáu</h1>

  <button id="loginBtn" class="link-btn">ƒêƒÉng nh·∫≠p b·∫±ng Google</button>
  <div id="userPanel" style="display:none;">
    Xin ch√†o, <span id="userName"></span>!
    <button id="logoutBtn" class="link-btn">ƒêƒÉng xu·∫•t</button>
  </div>

  <div id="searchSection" style="padding: 0 20px;">
    <input id="searchInput" placeholder="T√¨m ki·∫øm t√†i li·ªáu">
    <button id="searchBtn" class="link-btn">üîç T√¨m ki·∫øm</button>
  </div>

  <div id="createSection" style="display:none; padding: 0 20px;">
    <button id="addBtn" class="link-btn">‚ûï Th√™m t√†i li·ªáu</button>
    <div id="docsContainer"></div>
  </div>

  <footer><u>¬©2025 | Khoan VN</u></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "API_KEY",
      authDomain: "chat-hacker-82e55.firebaseapp.com",
      projectId: "chat-hacker-82e55",
      storageBucket: "chat-hacker-82e55.appspot.com",
      messagingSenderId: "918654199628",
      appId: "1:918654199628:web:8855d7d4c4301da8a191e9",
      measurementId: "G-6X2W1618S9"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app), db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let todayCount = 0;

    document.getElementById('loginBtn').onclick = async () => {
      try { await signInWithPopup(auth, provider); location.reload(); }
      catch (e) { alert("L·ªói ƒëƒÉng nh·∫≠p: " + e.message); }
    };
    document.getElementById('logoutBtn').onclick = async () => {
      await signOut(auth); location.reload();
    };

    onAuthStateChanged(auth, async user => {
      if (user) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userPanel').style.display = 'block';
        document.getElementById('userName').textContent = user.displayName;
        document.getElementById('createSection').style.display = 'block';
        await updateTodayCount(user.uid);
        await loadDocs();
      }
    });

    async function updateTodayCount(uid) {
      const now = new Date(), start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const snap = await getDocs(query(collection(db,'docs'), where('authorUid','==',uid), where('timestamp','>=',start)));
      todayCount = snap.size;
    }

    document.getElementById('addBtn').onclick = () => {
      if (todayCount >= 10) alert('B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n 10 t√†i li·ªáu h√¥m nay.');
      else createUploadForm();
    };

    document.getElementById('searchBtn').onclick = () => {
      const term = document.getElementById('searchInput').value.trim().toLowerCase();
      if (term) loadDocs(term);
    };

    function createUploadForm() {
      const div = document.createElement('div'); div.className = 'doc-item';

      const imgLink = document.createElement('input'); imgLink.placeholder = 'URL ·∫£nh b√¨a (b·∫Øt bu·ªôc)';
      const preview = document.createElement('img'); preview.className = 'preview';
      imgLink.oninput = () => preview.src = imgLink.value.trim() || '';

      const title = document.createElement('input'); title.placeholder = 'Gi·ªõi thi·ªáu (b·∫Øt bu·ªôc, max 50)'; title.maxLength = 50;
      const note = document.createElement('textarea'); note.placeholder = 'Ghi ch√∫ (t√πy ch·ªçn)';
      const created = document.createElement('input'); created.type = 'date'; created.value = new Date().toISOString().split('T')[0];
      const urlInp = document.createElement('input'); urlInp.placeholder = 'Link t√†i li·ªáu (b·∫Øt bu·ªôc)';
      const btnText = document.createElement('input'); btnText.placeholder = 'Ch·ªØ button (b·∫Øt bu·ªôc, max 30)'; btnText.maxLength = 30;
      const author = document.createElement('input'); author.placeholder = 'T√™n ng∆∞·ªùi ƒëƒÉng (b·∫Øt bu·ªôc, max 30)'; author.maxLength = 30;
      const privacy = document.createElement('select'); privacy.innerHTML = '<option value="public">C√¥ng khai</option><option value="private">Ri√™ng t∆∞</option>';

      const btn = document.createElement('button'); btn.textContent = 'T·∫°o t√†i li·ªáu'; btn.className = 'link-btn';
      btn.onclick = async () => {
        const errors = [];
        if (!imgLink.value.trim()) errors.push("Thi·∫øu ·∫£nh b√¨a.");
        if (!title.value.trim()) errors.push("Thi·∫øu gi·ªõi thi·ªáu.");
        if (!urlInp.value.trim()) errors.push("Thi·∫øu link t√†i li·ªáu.");
        if (!/^https?:\/\/.+/.test(urlInp.value.trim())) errors.push("Link ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://");
        if (!btnText.value.trim()) errors.push("Thi·∫øu ch·ªØ n√∫t.");
        if (!author.value.trim()) errors.push("Thi·∫øu t√™n ng∆∞·ªùi ƒëƒÉng.");
        if (errors.length) return alert("L·ªói:\n" + errors.join("\n"));

        const u = auth.currentUser;
        const data = {
          imgUrl: imgLink.value.trim(),
          intro: title.value.trim(),
          customNote: note.value.trim(),
          linkText: btnText.value.trim(),
          linkUrl: urlInp.value.trim(),
          authorName: author.value.trim(),
          authorUid: u.uid,
          private: privacy.value === 'private',
          timestamp: serverTimestamp(),
          createdDate: created.value
        };
        await addDoc(collection(db,'docs'), data);
        todayCount++;
        await loadDocs();
        document.getElementById('docsContainer').lastElementChild?.scrollIntoView({ behavior: 'smooth' });
      };

      div.append(imgLink, preview, title, note, created, urlInp, btnText, author, privacy, btn);
      document.getElementById('docsContainer').append(div);
    }

    async function loadDocs(term='') {
      const q = term
        ? query(collection(db,'docs'), where('title_lower','>=',term), where('title_lower','<',term+'\uf8ff'), orderBy('title_lower'))
        : query(collection(db,'docs'), orderBy('timestamp','desc'));
      const snaps = await getDocs(q);
      const cont = document.getElementById('docsContainer'); cont.innerHTML = '';
      const uid = auth.currentUser?.uid;
      snaps.forEach(s => {
        const d = s.data();
        if (!d.private || d.authorUid === uid) {
          const e = document.createElement('div'); e.className = 'doc-item';
          if (d.imgUrl) {
            const im = document.createElement('img'); im.src = d.imgUrl; im.className = 'preview'; e.append(im);
          }
          if (d.intro) e.append(document.createElement('p')).textContent = 'üìå ' + d.intro;
          if (d.customNote) e.append(document.createElement('p')).textContent = d.customNote;
          const b = document.createElement('button'); b.textContent = d.linkText; b.className = 'link-btn';
          b.onclick = () => window.open(d.linkUrl, '_blank'); e.append(b);
          const m = document.createElement('div'); m.textContent = `T√°c gi·∫£: ${d.authorName} | Ng√†y: ${d.createdDate}`; e.append(m);
          if (uid && d.authorUid === uid) {
            const del = document.createElement('button'); del.textContent='X√≥a'; del.className='delete-btn';
            del.onclick = () => { if (confirm('X√°c nh·∫≠n x√≥a?')) deleteDoc(doc(db,'docs',s.id)).then(()=>loadDocs(term)); };
            e.append(del);
          }
          cont.append(e);
        }
      });
    }
  </script>
</body>
</html>
