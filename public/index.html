<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Chia sẻ Tài liệu</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>📘 Chia sẻ Tài liệu</h1>
  <button id="loginBtn" class="link-btn">Đăng nhập bằng Google</button>
  <div id="userPanel" style="display:none;">
    Xin chào, <span id="userName"></span>!
    <button id="logoutBtn" class="link-btn">Đăng xuất</button>
  </div>
  <div id="createSection" style="display:none;">
    <div id="docsContainer"></div>
  </div>
  <div id="searchSection">
    <input id="searchInput" placeholder="Tìm (không phân biệt hoa/thường)">
  </div>
  <footer><u>©2025 | Khoan VN</u></footer>

  <!-- Nút cố định luôn hiện -->
  <button id="fixedAddBtn" class="link-btn">➕ Thêm tài liệu</button>
  <button id="fixedSearchBtn" class="link-btn">🔍 Tìm kiếm</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDJtJvPdg9owkQhu99U82r9cE0YaGmcLbo",
      authDomain: "chat-hacker-82e55.firebaseapp.com",
      projectId: "chat-hacker-82e55",
      storageBucket: "chat-hacker-82e55.appspot.com",
      messagingSenderId: "918654199628",
      appId: "1:918654199628:web:8855d7d4c4301da8a191e9",
      measurementId: "G-6X2W1618S9"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app), db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let todayCount = 0;

    document.getElementById('loginBtn').onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
        location.reload();
      } catch (e) {
        alert("Lỗi đăng nhập: " + e.message);
      }
    };
    document.getElementById('logoutBtn').onclick = async () => {
      await signOut(auth);
      location.reload();
    };
    onAuthStateChanged(auth, async user => {
      if (user) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userPanel').style.display = 'block';
        document.getElementById('userName').textContent = user.displayName;
        await updateTodayCount(user.uid);
        await loadDocs();
      }
    });
    async function updateTodayCount(uid) {
      const now = new Date(), start = new Date(now.getFullYear(),now.getMonth(),now.getDate());
      const snap = await getDocs(query(collection(db,'docs'), where('authorUid','==',uid), where('timestamp','>=',start)));
      todayCount = snap.size;
    }
    document.getElementById('fixedAddBtn').onclick = () => {
      if (todayCount >= 10) alert('Bạn đã đạt giới hạn 10 tài liệu hôm nay.');
      else createUploadForm();
    };
    document.getElementById('fixedSearchBtn').onclick = () => {
      const t = document.getElementById('searchInput').value.trim().toLowerCase();
      if (t) loadDocs(t);
    };

    function createUploadForm() {
      const div = document.createElement('div'); div.className = 'doc-item';

      const imgLink = document.createElement('input');
      imgLink.placeholder = 'Nhập URL ảnh bìa (bắt buộc)';
      const preview = document.createElement('img'); preview.className = 'preview';

      imgLink.oninput = () => {
        const v = imgLink.value.trim();
        preview.src = v || '';
      };

      const title = document.createElement('input');
      title.placeholder = 'Giới thiệu (bắt buộc, max 50)';
      title.maxLength = 50;

      const note = document.createElement('textarea');
      note.placeholder = 'Ghi chú (tùy chọn)';

      const createdLabel = document.createElement('label');
      createdLabel.textContent = 'Ngày đăng:';
      const created = document.createElement('input');
      created.type = 'date';
      created.value = new Date().toISOString().split('T')[0];

      const urlInp = document.createElement('input');
      urlInp.placeholder = 'Link liên kết (bắt buộc)';

      const btnText = document.createElement('input');
      btnText.placeholder = 'Chữ button (bắt buộc, max 30)';
      btnText.maxLength = 30;

      const author = document.createElement('input');
      author.placeholder = 'Tên người đăng (bắt buộc, max 30)';
      author.maxLength = 30;

      const privacy = document.createElement('select');
      privacy.innerHTML = `<option value="public">Công khai</option><option value="private">Riêng tư</option>`;

      const btn = document.createElement('button');
      btn.textContent = 'Tạo tài liệu';
      btn.className = 'link-btn';
      btn.onclick = async () => {
        const errors = [];
        if (!imgLink.value.trim()) errors.push("Bạn chưa nhập URL ảnh bìa.");
        if (!title.value.trim()) errors.push("Bạn chưa nhập giới thiệu.");
        if (!urlInp.value.trim()) errors.push("Bạn chưa nhập liên kết.");
        if (!/^https?:\/\/.+/.test(urlInp.value.trim())) errors.push("Link phải bắt đầu bằng http:// hoặc https://");
        if (!btnText.value.trim()) errors.push("Bạn chưa nhập chữ nút.");
        if (!author.value.trim()) errors.push("Bạn chưa nhập tên người đăng.");
        if (errors.length) return alert("❌ Lỗi:\n"+errors.join("\n"));

        const u = auth.currentUser;
        const data = {
          imgUrl: imgLink.value.trim(),
          intro: title.value.trim(),
          customNote: note.value.trim(),
          linkText: btnText.value.trim(),
          linkUrl: urlInp.value.trim(),
          authorName: author.value.trim(),
          authorUid: u.uid,
          private: privacy.value === 'private',
          timestamp: serverTimestamp(),
          createdDate: created.value
        };
        await addDoc(collection(db,'docs'), data);
        todayCount++;
        await loadDocs();
        const last = document.getElementById('docsContainer').lastElementChild;
        if (last) last.scrollIntoView({ behavior: 'smooth', block: 'end' });
      };

      div.append(imgLink, preview, title, note, createdLabel, created, urlInp, btnText, author, privacy, btn);
      document.getElementById('docsContainer').append(div);
    }

    async function loadDocs(term='') {
      const q = term
        ? query(collection(db,'docs'), where('title_lower','>=',term), where('title_lower','<',term+'\uf8ff'), orderBy('title_lower'))
        : query(collection(db,'docs'), orderBy('timestamp','desc'));
      const snaps = await getDocs(q);
      const cont = document.getElementById('docsContainer'); cont.innerHTML = '';
      const uid = auth.currentUser?.uid;
      snaps.forEach(s => {
        const d = s.data();
        if (!d.private || d.authorUid === uid) {
          const e = document.createElement('div'); e.className = 'doc-item';
          if (d.imgUrl) {
            const im = document.createElement('img'); im.src = d.imgUrl; im.className = 'preview'; e.append(im);
          }
          if (d.intro) e.append(document.createElement('p')).textContent = '📌 ' + d.intro;
          if (d.customNote) e.append(document.createElement('p')).textContent = d.customNote;
          const b = document.createElement('button'); b.textContent = d.linkText; b.className = 'link-btn'; b.onclick = () => window.open(d.linkUrl,'_blank');
          e.append(b);
          const m = document.createElement('div'); m.textContent = `Tác giả: ${d.authorName} | Ngày: ${d.createdDate}`;
          e.append(m);
          if (uid && d.authorUid === uid) {
            const del = document.createElement('button'); del.textContent = 'Xóa'; del.className = 'delete-btn';
            del.onclick = () => { if (confirm('Xác nhận xóa?')) deleteDoc(doc(db,'docs', s.id)).then(()=>loadDocs(term)); };
            e.append(del);
          }
          cont.append(e);
        }
      });
    }
  </script>
</body>
</html>        if (!imgLink.value.trim()) errors.push("Bạn chưa nhập URL ảnh bìa.");
        if (!title.value.trim()) errors.push("Bạn chưa nhập giới thiệu.");
        if (!urlInp.value.trim()) errors.push("Bạn chưa nhập liên kết.");
        if (!/^https?:\/\/.+/.test(urlInp.value.trim())) errors.push("Link phải bắt đầu bằng http:// hoặc https://");
        if (!btnText.value.trim()) errors.push("Bạn chưa nhập chữ nút.");
        if (!author.value.trim()) errors.push("Bạn chưa nhập tên người đăng.");

        if (errors.length) {
          alert("❌ Lỗi:\n" + errors.join("\n"));
          return;
        }

        const u = auth.currentUser;
        const data = {
          imgUrl: imgLink.value.trim(),
          intro: title.value.trim(),
          customNote: note.value.trim(),
          linkText: btnText.value.trim(),
          linkUrl: urlInp.value.trim(),
          authorName: author.value.trim(),
          authorUid: u.uid,
          private: privacy.value === 'private',
          timestamp: serverTimestamp(),
          createdDate: created.value
        };
        if (expire.value) data.expireDate = expire.value;

        await addDoc(collection(db, 'docs'), data);
        todayCount++; loadDocs();
      };

      div.append(imgLink, preview, title, note, createdLabel, created, expireLabel, expire, urlInp, btnText, author, privacy, btn);
      document.getElementById('docsContainer').append(div);
    }

    async function loadDocs(term='') {
      const q = term
        ? query(collection(db,'docs'), where('title_lower','>=',term), where('title_lower','<',term+'\uf8ff'), orderBy('title_lower'))
        : query(collection(db,'docs'), orderBy('timestamp','desc'));
      const snaps = await getDocs(q);
      const cont = document.getElementById('docsContainer'); cont.innerHTML = ''; const uid = auth.currentUser?.uid;
      snaps.forEach(s => {
        const d = s.data();
        if (!d.private || d.authorUid === uid) {
          const e = document.createElement('div'); e.className = 'doc-item';
          if (d.imgUrl) { const im = document.createElement('img'); im.src = d.imgUrl; im.className='preview'; e.append(im); }
          if (d.intro) e.append(document.createElement('p')).textContent = '📌 ' + d.intro;
          if (d.customNote) e.append(document.createElement('p')).textContent = d.customNote;
          const b = document.createElement('button'); b.textContent = d.linkText; b.className = 'link-btn';
          b.onclick = () => window.open(d.linkUrl, '_blank'); e.append(b);
          const m = document.createElement('div');
          m.textContent = `Tác giả: ${d.authorName} | Ngày: ${d.createdDate}` + (d.expireDate ? ` | Hạn: ${d.expireDate}` : '');
          e.append(m);
          if (uid && d.authorUid === uid) {
            const del = document.createElement('button'); del.textContent='Xóa'; del.className='delete-btn';
            del.onclick = () => { if (confirm('Xác nhận xóa?')) deleteDoc(doc(db,'docs', s.id)).then(()=>loadDocs(term)); };
            e.append(del);
          }
          cont.append(e);
        }
      });
    }

    document.getElementById('searchBtn').onclick = () => {
      const t = document.getElementById('searchInput').value.trim().toLowerCase();
      if (t) loadDocs(t);
    };
    document.getElementById('nextSearchBtn').onclick = () => {
      const t = document.getElementById('searchInput').value.trim().toLowerCase();
      if (t) loadDocs(t);
    };
  </script>
</body>
</html>
