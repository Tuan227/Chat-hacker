<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chia sẻ tài liệu</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { cursor: pointer; }
    .link-btn { background: red; color: white; border: none; padding: 6px 12px; margin-top: 5px; }
    .link-btn:active { background: #00ff00; }
    .doc-item { border: 1px solid #ccc; margin: 10px 0; padding: 10px; position: relative; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: red; color: white; border: none; padding: 4px 8px; }
    .preview { max-width: 120px; max-height: 120px; margin-top: 8px; }
    textarea, input, select { display:block; margin: 5px 0; width: 100%; padding: 4px; }
    footer { margin-top: 40px; font-size: 14px; color: #555; text-align: center; }
  </style>
</head>
<body>
  <h1>Chia sẻ Tài liệu</h1>
  <button id="loginBtn">Đăng nhập bằng Google</button>
  <div id="userPanel" style="display:none;">
    Xin chào, <span id="userName"></span>! <button id="logoutBtn">Đăng xuất</button>
  </div>
  <div id="createSection" style="display:none;">
    <button id="addBtn">➕ Thêm tài liệu</button>
    <div id="docsContainer"></div>
  </div>

  <div id="searchSection" style="margin-top:20px;">
    <input id="searchInput" placeholder="Tìm (không phân biệt hoa/thường)">
    <button id="searchBtn">🔍 Tìm kiếm</button>
    <button id="nextSearchBtn">Tìm tiếp</button>
  </div>

  <footer><del>©2025 | Khoan VN</del></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, where, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDJtJvPdg9owkQhu99U82r9cE0YaGmcLbo",
      authDomain: "chat-hacker-82e55.firebaseapp.com",
      projectId: "chat-hacker-82e55",
      storageBucket: "chat-hacker-82e55.appspot.com",
      messagingSenderId: "918654199628",
      appId: "1:918654199628:web:8855d7d4c4301da8a191e9",
      measurementId: "G-6X2W1618S9"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    let todayCount = 0;
    const provider = new GoogleAuthProvider();

    document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    onAuthStateChanged(auth, async user => {
      if (user) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userPanel').style.display = 'block';
        document.getElementById('userName').textContent = user.displayName;
        document.getElementById('createSection').style.display = 'block';
        await updateTodayCount(user.uid);
        loadDocs();
      } else {
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('createSection').style.display = 'none';
      }
    });

    async function updateTodayCount(uid) {
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const q = query(collection(db, 'docs'),
                      where('authorUid', '==', uid),
                      where('timestamp', '>=', start));
      let snap = await getDocs(q);
      todayCount = snap.size;
    }

    document.getElementById('addBtn').onclick = () => {
      if (todayCount >= 10) {
        alert('Đã đạt giới hạn 10 tài liệu trong ngày.');
        return;
      }
      createUploadForm();
    };

    function createUploadForm() {
      const div = document.createElement('div');
      div.className = 'doc-item';

      const imgInput = document.createElement('input');
      imgInput.type = 'file';
      imgInput.accept = 'image/*';

      const preview = document.createElement('img');
      preview.className = 'preview';

      imgInput.onchange = () => {
        const f = imgInput.files[0];
        if (!f) return;
        const imgRef = sRef(storage, 'images/' + Date.now() + '_' + f.name);
        uploadBytes(imgRef, f).then(r => getDownloadURL(r.ref)).then(url => {
          preview.src = url;
        });
      };

      const intro = document.createElement('textarea');
      intro.placeholder = 'Giới thiệu ngắn...';
      intro.maxLength = 200;

      const customNote = document.createElement('textarea');
      customNote.placeholder = 'Ghi bất kỳ...';
      customNote.maxLength = 300;

      const linkText = document.createElement('input');
      linkText.placeholder = 'Chữ trong button (tối đa 50)';
      linkText.maxLength = 50;

      const linkUrl = document.createElement('input');
      linkUrl.placeholder = 'Link liên kết';

      const authorInput = document.createElement('input');
      authorInput.placeholder = 'Tên người đăng (tối đa 30)';
      authorInput.maxLength = 30;

      const dateNow = new Date().toISOString().split("T")[0];
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.value = dateNow;

      const expiryInput = document.createElement('input');
      expiryInput.type = 'date';

      const privacySel = document.createElement('select');
      privacySel.innerHTML = `
        <option value="public">Công khai</option>
        <option value="private">Riêng tư</option>
      `;

      const createBtn = document.createElement('button');
      createBtn.textContent = 'Tạo';
      createBtn.className = 'link-btn';
      createBtn.onmousedown = () => createBtn.style.background = '#00ff00';
      createBtn.onmouseup = () => createBtn.style.background = 'red';

      createBtn.onclick = async () => {
        if (!preview.src || !linkText.value || !linkUrl.value || !authorInput.value) {
          alert("Vui lòng điền đủ thông tin bắt buộc.");
          return;
        }

        const cur = auth.currentUser;
        await addDoc(collection(db, 'docs'), {
          imgUrl: preview.src,
          intro: intro.value,
          customNote: customNote.value,
          linkText: linkText.value,
          linkUrl: linkUrl.value,
          authorName: authorInput.value,
          authorUid: cur.uid,
          private: privacySel.value === 'private',
          timestamp: serverTimestamp(),
          createdDate: dateInput.value,
          expireDate: expiryInput.value || null,
          title_lower: linkText.value.toLowerCase()
        });

        todayCount++;
        loadDocs();
      };

      div.append(
        imgInput, preview,
        intro, customNote,
        linkText, linkUrl,
        authorInput, dateInput, expiryInput,
        privacySel, createBtn
      );

      document.getElementById('docsContainer').append(div);
    }

    async function loadDocs(searchTerm = '') {
      let q = query(collection(db,'docs'), orderBy('timestamp','desc'));
      if (searchTerm) {
        q = query(collection(db,'docs'),
                  where('title_lower','>=', searchTerm),
                  where('title_lower','<', searchTerm + '\uf8ff'),
                  orderBy('title_lower'));
      }
      const snaps = await getDocs(q);
      const cont = document.getElementById('docsContainer');
      cont.innerHTML = '';
      const uid = auth.currentUser?.uid;

      snaps.forEach(snap => {
        const d = snap.data();
        if (!d.private || d.authorUid === uid) {
          const e = document.createElement('div');
          e.className = 'doc-item';
          e.id = snap.id;

          if (d.imgUrl) {
            const im = document.createElement('img');
            im.src = d.imgUrl;
            im.className = 'preview';
            e.append(im);
          }

          if (d.intro) e.append(document.createTextNode("📌 " + d.intro));
          if (d.customNote) e.append(document.createElement('p')).innerText = d.customNote;

          const b = document.createElement('button');
          b.textContent = d.linkText;
          b.className = 'link-btn';
          b.onmousedown = () => b.style.background = '#00ff00';
          b.onmouseup = () => b.style.background = 'red';
          b.onclick = () => window.open(d.linkUrl, '_blank');
          e.append(b);

          const authorDiv = document.createElement('div');
          authorDiv.textContent = 'Tạo bởi: ' + d.authorName + (d.createdDate ? ` vào ${d.createdDate}` : '');
          e.append(authorDiv);

          if (uid && d.authorUid === uid) {
            const del = document.createElement('button');
            del.textContent = 'Xóa';
            del.className = 'delete-btn';
            del.onclick = () => {
              if (confirm('Xác nhận xóa tài liệu này?')) {
                deleteDoc(doc(db,'docs',snap.id)).then(() => loadDocs(searchTerm));
              }
            };
            e.append(del);
          }

          cont.append(e);
        }
      });

      if (!searchTerm) cont.lastChild?.scrollIntoView({behavior:'smooth'});
      const p = new URLSearchParams(window.location.search).get('docId');
      if (p) document.getElementById(p)?.scrollIntoView({behavior:'smooth'});
    }

    document.getElementById('searchBtn').onclick = () => {
      const t = document.getElementById('searchInput').value.trim().toLowerCase();
      if (t) loadDocs(t);
    };

    document.getElementById('nextSearchBtn').onclick = () => {
      const t = document.getElementById('searchInput').value.trim().toLowerCase();
      if (t) loadDocs(t);
    };
  </script>
</body>
</html>
